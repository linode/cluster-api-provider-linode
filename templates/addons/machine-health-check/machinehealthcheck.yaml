apiVersion: cluster.x-k8s.io/v1beta2
kind: MachineHealthCheck
metadata:
  name: ${CLUSTER_NAME}-node-unhealthy-5m
spec:
  clusterName: ${CLUSTER_NAME}
  # (Optional) maxUnhealthy prevents further remediation if the cluster is already partially unhealthy
  remediation:
    triggerIf:
      unhealthyLessThanOrEqualTo: 2
  # Conditions to check on Nodes for matched Machines, if any condition is matched for the duration of its timeout, the Machine is considered unhealthy
  selector:
    matchLabels:
      cluster.x-k8s.io/deployment-name: ${CLUSTER_NAME}
  checks:
    unhealthyNodeConditions:
      - type: Ready
        status: Unknown
        timeoutSeconds: 300
      - type: Ready
        status: "False"
        timeoutSeconds: 300
---
apiVersion: cluster.x-k8s.io/v1beta2
kind: MachineHealthCheck
metadata:
  name: ${CLUSTER_NAME}-kcp-unhealthy-5m
spec:
  clusterName: ${CLUSTER_NAME}
  remediation:
    triggerIf:
      unhealthyLessThanOrEqualTo: 2
  selector:
    matchLabels:
      cluster.x-k8s.io/control-plane: ""
  checks:
    unhealthyNodeConditions:
      - type: Ready
        status: Unknown
        timeoutSeconds: 300
      - type: Ready
        status: "False"
        timeoutSeconds: 300
